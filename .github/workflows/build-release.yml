name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          # - ios

jobs:
  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN_FIT_YAAR }}

      - name: Setup EAS
        run: npm install -g eas-cli

      - name: Build Android APK (Preview)
        run: eas build --platform android --profile preview --non-interactive --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN_FIT_YAAR }}

      - name: Build Android AAB (Production)
        if: startsWith(github.ref, 'refs/tags/')
        run: eas build --platform android --profile production --non-interactive --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN_FIT_YAAR }}

  # build-ios:
  #   name: Build iOS IPA
  #   runs-on: macos-latest
  #   if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Setup Expo
  #       uses: expo/expo-github-action@v8
  #       with:
  #         expo-version: latest
  #         token: ${{ secrets.EXPO_TOKEN }}

  #     - name: Setup EAS
  #       run: npm install -g eas-cli

  #     - name: Build iOS (Preview)
  #       run: eas build --platform ios --profile preview --non-interactive --no-wait
  #       env:
  #         EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  #     - name: Build iOS (Production)
  #       if: startsWith(github.ref, 'refs/tags/')
  #       run: eas build --platform ios --profile production --non-interactive --no-wait
  #       env:
  #         EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android] # build-ios
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}